name: CI/CD to Cloud Run Major Match

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      - name: Install Dependencies
        run: npm install

      - name: Build Docker Image
        uses: docker/build-push-action@v2
        with:
          context: .
          dockerfile: Dockerfile
          push: false
          tags: major-match-backend:${{ github.sha }}

      - name: Configure Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: capstone-project-c23-ps149
          skip_install: false
          version: latest
        env:
          DB_HOSTNAME: ${{ secrets.DB_HOSTNAME }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          ACCESS_TOKEN_SECRET: ${{ secrets.ACCESS_TOKEN_SECRET }}
          REFRESH_TOKEN_SECRET: ${{ secrets.REFRESH_TOKEN_SECRET }}

      - name: Authenticate Docker to Google Container Registry
        run: gcloud auth configure-docker --quiet

      - name: Tag and Push Docker Image to Google Container Registry
        run: |
          docker tag major-match-backend:${{ github.sha }} gcr.io/capstone-project-c23-ps149/major-match-backend:${{ github.sha }}
          docker push gcr.io/capstone-project-c23-ps149/major-match-backend:${{ github.sha }}

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy major-match-backend \
            --image gcr.io/capstone-project-c23-ps149/major-match-backend:${{ github.sha }} \
            --platform managed \
            --region asia-shouteast2

      - name: Start Application
        run: |
          npm install
          npm start
        working-directory: /src
